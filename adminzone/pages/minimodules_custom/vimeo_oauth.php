<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2016

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    gallery_syndication
 */

i_solemnly_declare(I_UNDERSTAND_SQL_INJECTION | I_UNDERSTAND_XSS | I_UNDERSTAND_PATH_INJECTION);

require_code('vimeo');
require_code('oauth');

$service_name = 'vimeo';

$title = get_screen_title('OAUTH_TITLE', true, array($service_name));

$client_id = ensure_got_oauth_client_id($service_name);

$vimeo = new phpVimeo(get_option($service_name . '_client_id'), get_option($service_name . '_client_secret'));

$oauth_token = get_param_string('oauth_token', '');

if ($oauth_token == '') {
    // Grab initial unauthorized request tokens...
    $callback_url = static_evaluate_tempcode(build_url(array('page' => '_SELF'), '_SELF', null, false, false, true));
    $token = $vimeo->getRequestToken($callback_url);
    $auth_url = $vimeo->getAuthorizeUrl($token['oauth_token'], 'delete');

    // Store them...
    set_value($service_name . '_access_token', $token['oauth_token'], true);
    set_value($service_name . '_access_token_secret', $token['oauth_token_secret'], true);

    // Send off to authorize...
    $echo = redirect_screen($title, $auth_url);
    $echo->evaluate_echo();
    return;
}

// Got a response back...

$vimeo->setToken(get_value($service_name . '_access_token', null, true), get_value($service_name . '_access_token_secret', null, true));
$token = $vimeo->getAccessToken(get_param_string('oauth_verifier')); // Convert to long-term access tokens
$vimeo->setToken($token['oauth_token'], $token['oauth_token_secret']);
$ok = true;
try {

    $vimeo->call('vimeo.test.null');
} catch (VimeoAPIException $e) {

    require_lang('gallery_syndication_vimeo');
    attach_message(do_lang_tempcode('VIMEO_ERROR', escape_html(strval($e->getCode())), $e->getMessage(), escape_html(get_site_name())), 'warn');
    $out = do_lang_tempcode('SOME_ERRORS_OCCURRED');
    $ok = false;
}
if ($ok) {
    // Save long-term access tokens if it passed through okay
    set_value($service_name . '_access_token', $token['oauth_token'], true);
    set_value($service_name . '_access_token_secret', $token['oauth_token_secret'], true);
    $out = do_lang_tempcode('OAUTH_SUCCESS', escape_html($service_name));
}

$title->evaluate_echo();

$out->evaluate_echo();
